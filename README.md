# Wave to MP3 Converter

高速かつ低負荷なWAVEファイルからMP3への変換ツールです。コンソールアプリケーションとWindowsサービスの両方として動作します。

## 特徴

- **高速変換**: NAudioとLAMEを使用した効率的なオーディオ変換
- **低メモリ消費**: ストリーム処理による逐次変換でメモリ使用量を抑制
- **多機能**: 単一ファイル変換、バッチ変換、フォルダ監視機能を搭載
- **デュアルモード**: コンソールアプリケーションとWindowsサービスの両方で動作
- **詳細なログ**: ファイルログとWindowsイベントログの両方に対応

## システム要件

- .NET Framework 4.8.1
- Windows 7以降

## 使用方法

### コンソールアプリケーションとして

#### 単一ファイルの変換

```
WaveToMp3Converter.exe -f "C:\Music\song.wav"
```

出力ファイルは同じディレクトリに作成されます。別の出力先を指定する場合は `-o` オプションを使用します：

```
WaveToMp3Converter.exe -f "C:\Music\song.wav" -o "C:\MP3s"
```

#### ディレクトリ内のすべてのWAVEファイルを変換

```
WaveToMp3Converter.exe -d "C:\Music" -o "C:\MP3s"
```

サブディレクトリも含めて処理され、ディレクトリ構造は保持されます。

#### フォルダを高精度ポーリングで監視して自動変換

```
WaveToMp3Converter.exe -w "C:\WatchFolder" -o "C:\OutputFolder"
```

指定したフォルダを高精度タイマーによるポーリングで監視し、新しいWAVEファイルが追加されると自動的に変換します。ファイルの取りこぼしが発生しにくい安定した監視方式です。Ctrl+Cで監視を終了できます。

#### コマンドラインオプション一覧

| オプション | 説明 |
|------------|------|
| `-f, --file <ファイルパス>` | 変換する単一のWAVEファイルを指定 |
| `-d, --directory <ディレクトリパス>` | 指定されたディレクトリ内のすべてのWAVEファイルを変換 |
| `-o, --output <出力ディレクトリ>` | 変換されたMP3ファイルの出力先ディレクトリを指定 |
| `-w, --watch <監視ディレクトリ>` | 指定されたディレクトリを監視し、新しいWAVEファイルを自動変換 |
| `-h, --help` | ヘルプを表示 |

### Windowsサービスとして

#### 設定

サービスとして実行する前に、`WaveToMp3Converter.exe.config`ファイルに以下の設定を追加してください：

```xml
<configuration>
  <appSettings>
    <add key="WatchDirectory" value="C:\WatchFolder" />
    <add key="OutputDirectory" value="C:\OutputFolder" />
  </appSettings>
</configuration>
```

#### サービスのインストール

管理者権限でコマンドプロンプトを開き、以下のコマンドを実行します：

```
sc create WaveToMp3Converter binPath= "完全なパス\WaveToMp3Converter.exe" DisplayName= "Wave to MP3 Converter Service"
```

#### サービスの開始/停止

サービスは、Windowsのサービス管理コンソール（services.msc）から開始・停止できます。または、以下のコマンドを使用します：

```
sc start WaveToMp3Converter
sc stop WaveToMp3Converter
```

#### サービスのアンインストール

```
sc delete WaveToMp3Converter
```

## 技術的な詳細

### ストリーム処理について

このツールは、ファイル全体を一度にメモリに読み込むのではなく、ストリーム処理を使用して逐次的に変換を行います：

1. 固定サイズのバッファ（4096バイト）を使用してWAVEファイルを小さなチャンクで読み込み
2. 読み込んだチャンクをすぐにMP3にエンコードして出力
3. これを繰り返すことで、メモリ使用量を最小限に抑えながら変換を行う

このアプローチにより、以下のメリットがあります：

- メモリ使用量が一定であり、大きなファイルでもメモリ不足になりにくい
- 処理の進捗状況をリアルタイムで表示可能
- システムリソースを効率的に使用

### ログ機能

ログは以下の2つの場所に記録されます：

1. ファイルログ: アプリケーションと同じディレクトリに`WaveToMp3Converter.log`として保存
2. Windowsイベントログ: アプリケーションログに「WaveToMp3Converter」ソースとして記録（サービスモード時）

## トラブルシューティング

### 「ファイルにアクセスできません」エラー

他のアプリケーションでファイルが開かれている可能性があります。元のファイルを閉じてから再試行してください。

### 変換が遅い場合

- CPUの負荷が高い他のアプリケーションを終了する
- ハードディスクの空き容量が十分であることを確認する
- 一時的にリアルタイムウイルススキャンを無効にする

### サービスが起動しない場合

- App.configの設定が正しいか確認する
- ログファイルでエラーメッセージを確認する
- 指定したディレクトリへのアクセス権があることを確認する

## ライセンス

このプロジェクトは[MITライセンス](LICENSE)の下で提供されています。

## 謝辞

このプロジェクトは以下のオープンソースライブラリを使用しています：

- [NAudio](https://github.com/naudio/NAudio)
- [NAudio.Lame](https://github.com/Corey-M/NAudio.Lame)

## 更新履歴

### v1.0.0 (2025-03-24)
- 初回リリース